from typing import Dict, Any, Optional, List
from agents.base_agent import BaseAgent
from services.kernel_service import KernelService
from datetime import datetime

class SummarizerAgent(BaseAgent):
    """è¦ç´„ãƒ»æ•´å½¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - æ–‡æ›¸è¦ç´„ã¨æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã®å½¹å‰²"""
    
    def __init__(self, kernel_service: KernelService, prompt_version: str = "latest"):
        self.summaries_created = 0
        self.reports_created = 0
        super().__init__("summarizer", kernel_service, prompt_version)
    
    def get_description(self) -> str:
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®èª¬æ˜ã‚’è¿”ã™"""
        return "æ–‡æ›¸ã®è¦ç´„ã¨æƒ…å ±æ•´ç†ã®å°‚é–€å®¶ã€‚æ–‡æ›¸è¦ç´„ã®ç”Ÿæˆã¨Q&Aå†…å®¹ã®æ•´ç†ãƒ»æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã‚’è¡Œã„ã¾ã™ã€‚"
    
    def process_message(self, message: str, context: Optional[Dict[str, Any]] = None) -> str:
        """
        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ï¼ˆåŸºæœ¬çš„ã«ã¯ä½¿ç”¨ã—ãªã„ï¼‰
        
        Args:
            message: å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            context: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
            
        Returns:
            å‡¦ç†çµæœ
        """
        return "è¦ç´„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ç‰¹å®šã®ã‚¿ã‚¹ã‚¯ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
    
    def create_document_summary(self, document_content: str, context: Optional[Dict[str, Any]] = None) -> str:
        """
        æ–‡æ›¸å…¨ä½“ã®è¦ç´„ã‚’ä½œæˆ
        
        Args:
            document_content: æ–‡æ›¸å†…å®¹
            context: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
            
        Returns:
            è¦ç´„ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        prompt_parts = [
            f"ã€æ–‡æ›¸å†…å®¹ã€‘\\n{document_content}",
            "",
            "ã€æŒ‡ç¤ºã€‘",
            "ä¸Šè¨˜ã®æ–‡æ›¸å…¨ä½“ã‚’èª­ã‚“ã§ã€ä»¥ä¸‹ã®è¦ä»¶ã«å¾“ã£ã¦ç°¡æ½”ã§åŒ…æ‹¬çš„ãªè¦ç´„ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š",
            "",
            "1. æ–‡æ›¸ã®ä¸»è¦ãªãƒ†ãƒ¼ãƒã‚„ç›®çš„ã‚’æ˜ç¢ºã«ã™ã‚‹",
            "2. é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’3-5å€‹ã«çµã£ã¦æ•´ç†ã™ã‚‹", 
            "3. å„ãƒã‚¤ãƒ³ãƒˆã¯1-2æ–‡ã§ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹",
            "4. å°‚é–€ç”¨èªã¯é©åˆ‡ã«èª¬æ˜ã‚’åŠ ãˆã‚‹",
            "5. èª­è€…ãŒæ–‡æ›¸å…¨ä½“ã®æ¦‚è¦ã‚’ç´ æ—©ãç†è§£ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹",
            "",
            "è¦ç´„ã¯ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š",
            "## ğŸ“‹ æ–‡æ›¸è¦ç´„",
            "**ä¸»è¦ãƒ†ãƒ¼ãƒï¼š** [æ–‡æ›¸ã®ä¸­å¿ƒçš„ãªãƒ†ãƒ¼ãƒ]",
            "",
            "**é‡è¦ãƒã‚¤ãƒ³ãƒˆï¼š**",
            "1. [ãƒã‚¤ãƒ³ãƒˆ1]",
            "2. [ãƒã‚¤ãƒ³ãƒˆ2]", 
            "3. [ãƒã‚¤ãƒ³ãƒˆ3]",
            "...",
            "",
            "è¦ç´„ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
        ]
        
        self.summaries_created += 1
        return "\\n".join(prompt_parts)
    
    def create_final_report(self, document_content: str, qa_pairs: List[Dict[str, Any]], summary: str = "") -> str:
        """
        æœ€çµ‚ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
        
        Args:
            document_content: å…ƒã®æ–‡æ›¸å†…å®¹
            qa_pairs: Q&Aãƒšã‚¢ã®ãƒªã‚¹ãƒˆ
            summary: äº‹å‰ã«ä½œæˆã•ã‚ŒãŸè¦ç´„
            
        Returns:
            æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        # Q&Aãƒšã‚¢ã‚’æ–‡å­—åˆ—å½¢å¼ã«æ•´å½¢
        qa_text = self._format_qa_pairs_for_prompt(qa_pairs)
        
        prompt_parts = [
            f"ã€å…ƒæ–‡æ›¸ã€‘\\n{document_content[:2000]}..." if len(document_content) > 2000 else f"ã€å…ƒæ–‡æ›¸ã€‘\\n{document_content}",
            "",
            f"ã€æ–‡æ›¸è¦ç´„ã€‘\\n{summary}" if summary else "",
            "",
            f"ã€Q&A ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…å®¹ã€‘\\n{qa_text}",
            "",
            "ã€æŒ‡ç¤ºã€‘",
            "ä¸Šè¨˜ã®æƒ…å ±ã‚’åŸºã«ã€ä»¥ä¸‹ã®æ§‹é€ ã‚’æŒã¤åŒ…æ‹¬çš„ãªMarkdownå½¢å¼ã®æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š",
            "",
            "## æ§‹é€ è¦ä»¶ï¼š",
            "1. **ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³**",
            "   - æ–‡æ›¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨åŸºæœ¬æƒ…å ±",
            "   - æ–‡æ›¸ã®è¦ç´„ï¼ˆæ—¢å­˜ã®è¦ç´„ã‚’æ”¹è‰¯ãƒ»æ´»ç”¨ï¼‰",
            "",
            "2. **Q&A ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœ**",
            "   - å„Q&Aãƒšã‚¢ã‚’è¦‹ã‚„ã™ãæ•´ç†",
            "   - è³ªå•ã¨å›ç­”ã‚’é©åˆ‡ã«æ§‹é€ åŒ–",
            "   - é‡è¦ãªæ´å¯Ÿã‚„ãƒã‚¤ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ",
            "",
            "3. **ä¸»è¦ãªå­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ**",
            "   - Q&Aã‹ã‚‰å¾—ã‚‰ã‚ŒãŸé‡è¦ãªçŸ¥è­˜ã‚’ã¾ã¨ã‚",
            "   - å®Ÿç”¨çš„ãªç¤ºå”†ã‚„å¿œç”¨å¯èƒ½ãªç‚¹ã‚’æŠ½å‡º",
            "",
            "4. **çµè«–ãƒ»ã¾ã¨ã‚**",
            "   - æ–‡æ›¸ã¨Q&Aã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸå…¨ä½“çš„ãªç†è§£",
            "   - ä»Šå¾Œã®å­¦ç¿’ã‚„å¿œç”¨ã¸ã®ç¤ºå”†",
            "",
            "## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦ä»¶ï¼š",
            "- é©åˆ‡ãªMarkdownè¨˜æ³•ã‚’ä½¿ç”¨",
            "- è¦‹å‡ºã—ã€ãƒªã‚¹ãƒˆã€å¼·èª¿ãªã©ã§æ§‹é€ åŒ–",
            "- èª­ã¿ã‚„ã™ãæ•´ç†ã•ã‚ŒãŸå½¢å¼",
            "- å¿…è¦ã«å¿œã˜ã¦è¡¨ã‚„å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ´»ç”¨",
            "",
            "æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆï¼ˆMarkdownå½¢å¼ï¼‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
        ]
        
        self.reports_created += 1
        return "\\n".join([part for part in prompt_parts if part])
    
    def _format_qa_pairs_for_prompt(self, qa_pairs: List[Dict[str, Any]]) -> str:
        """Q&Aãƒšã‚¢ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§UIã«é©ã—ãŸå½¢å¼ã«æ•´å½¢"""
        if not qa_pairs:
            return "Q&Aãƒšã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        
        formatted_pairs = []
        for i, qa in enumerate(qa_pairs, 1):
            question = qa.get('question', 'è³ªå•ãªã—')
            answer = qa.get('answer', 'å›ç­”ãªã—')
            
            formatted_pairs.append(f"Q{i}: {question}")
            formatted_pairs.append(f"A{i}: {answer}")
            formatted_pairs.append("---")
        
        return "\\n\\n".join(formatted_pairs)
    
    def create_section_summary(self, section_content: str, qa_pairs: List[Dict[str, Any]]) -> str:
        """
        ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ¯ã®è¦ç´„ã‚’ä½œæˆ
        
        Args:
            section_content: ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹
            qa_pairs: ãã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®Q&Aãƒšã‚¢
            
        Returns:
            ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´„ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        qa_text = self._format_qa_pairs_for_prompt(qa_pairs)
        
        prompt_parts = [
            f"ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹ã€‘\\n{section_content}",
            "",
            f"ã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®Q&Aã€‘\\n{qa_text}",
            "",
            "ã€æŒ‡ç¤ºã€‘",
            "ä¸Šè¨˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹ã¨Q&Aã‚’åŸºã«ã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç‚¹ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ï¼š",
            "",
            "1. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸»è¦ãªå†…å®¹ã‚’2-3æ–‡ã§è¦ç´„",
            "2. Q&Aã‹ã‚‰æ˜ã‚‰ã‹ã«ãªã£ãŸé‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’æ•´ç†",
            "3. ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å­¦ã¹ã‚‹ä¸»è¦ãªçŸ¥è­˜ã‚„æ¦‚å¿µã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ",
            "",
            "è¦ç´„ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
        ]
        
        return "\\n".join(prompt_parts)
    
    def improve_qa_formatting(self, qa_pairs: List[Dict[str, Any]]) -> str:
        """
        Q&Aãƒšã‚¢ã®æ•´å½¢ãƒ»æ”¹å–„
        
        Args:
            qa_pairs: æ•´å½¢ã™ã‚‹Q&Aãƒšã‚¢
            
        Returns:
            æ•´å½¢å¾Œã®Q&A
        """
        qa_text = self._format_qa_pairs_for_prompt(qa_pairs)
        
        prompt_parts = [
            f"ã€ç¾åœ¨ã®Q&Aå†…å®¹ã€‘\\n{qa_text}",
            "",
            "ã€æŒ‡ç¤ºã€‘",
            "ä¸Šè¨˜ã®Q&Aå†…å®¹ã‚’ä»¥ä¸‹ã®è¦ä»¶ã«å¾“ã£ã¦æ•´å½¢ãƒ»æ”¹å–„ã—ã¦ãã ã•ã„ï¼š",
            "",
            "1. è³ªå•æ–‡ã‚’ç°¡æ½”ã§æ˜ç¢ºã«ã™ã‚‹",
            "2. å›ç­”ã®æ§‹é€ ã‚’æ•´ç†ã—ã€èª­ã¿ã‚„ã™ãã™ã‚‹", 
            "3. é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’é©åˆ‡ã«å¼·èª¿ã™ã‚‹",
            "4. å¿…è¦ã«å¿œã˜ã¦é–¢é€£æ€§ã®é«˜ã„Q&AåŒå£«ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹",
            "5. Markdownè¨˜æ³•ã‚’ä½¿ç”¨ã—ã¦è¦‹ã‚„ã™ãæ•´å½¢ã™ã‚‹",
            "",
            "æ•´å½¢å¾Œã®Q&Aï¼ˆMarkdownå½¢å¼ï¼‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
        ]
        
        return "\\n".join(prompt_parts)
    
    def create_executive_summary(self, full_report: str) -> str:
        """
        ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
        
        Args:
            full_report: å®Œå…¨ãªãƒ¬ãƒãƒ¼ãƒˆå†…å®¹
            
        Returns:
            ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        prompt_parts = [
            f"ã€å®Œå…¨ãƒ¬ãƒãƒ¼ãƒˆã€‘\\n{full_report}",
            "",
            "ã€æŒ‡ç¤ºã€‘",
            "ä¸Šè¨˜ã®ãƒ¬ãƒãƒ¼ãƒˆå…¨ä½“ã‚’åŸºã«ã€ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š",
            "",
            "1. æœ€ã‚‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’3-5å€‹ã«çµã‚‹",
            "2. å„ãƒã‚¤ãƒ³ãƒˆã‚’1-2æ–‡ã§ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹",
            "3. ãƒ“ã‚¸ãƒã‚¹ã‚„å®Ÿç”¨é¢ã§ã®ç¤ºå”†ãŒã‚ã‚Œã°å«ã‚ã‚‹",
            "4. 2-3åˆ†ã§èª­ã‚ã‚‹é•·ã•ã«åã‚ã‚‹",
            "",
            "ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
        ]
        
        return "\\n".join(prompt_parts)
    
    def get_status(self) -> Dict[str, Any]:
        """ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—"""
        return {
            "summaries_created": self.summaries_created,
            "reports_created": self.reports_created,
            "timestamp": datetime.now().isoformat()
        }